<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>KL ESPORTS - Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* Dashboard specific styles */
:root { --p-green: #0fa958; --bg-light: #f5fff9; --text-dark: #222; }
body{ margin:0; font-family:'Segoe UI', sans-serif; background: var(--bg-light); padding-bottom: 80px; }

#loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; justify-content: center; align-items: center; z-index: 10000; }
.spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--p-green); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.header{ display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:white; box-shadow:0 2px 5px rgba(0,0,0,0.05); position: sticky; top:0; z-index:100; }
.header-left{ display:flex; align-items:center; gap:12px; }
.header-left img{ width:42px; height:42px; border-radius:50%; border:2px solid var(--p-green); object-fit:cover; background: #eee; }
.header-left span{ font-weight:bold; font-size:15px; color:#333; }
.wallet-box{ font-weight:bold; color:var(--p-green); background:#e8f5e9; padding:6px 15px; border-radius:20px; font-size: 14px; }

.categories{ display:flex; overflow-x:auto; padding:12px 10px; gap:10px; background:white; scrollbar-width: none; border-bottom: 1px solid #f0f0f0; }
.category{ flex:0 0 auto; padding:8px 18px; border-radius:20px; background:#f5f5f5; color:#777; font-weight:bold; font-size:11px; cursor:pointer; border: 1px solid #eee; transition: 0.3s; }
.category.active{ background:var(--p-green); color:white; border-color:var(--p-green); box-shadow: 0 4px 10px rgba(15, 169, 88, 0.2); }

.matches-container { padding: 15px; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.match-card { background: #fff; border-radius: 15px; margin-bottom: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); position: relative; border: 1px solid #f0f0f0; cursor: pointer; overflow: hidden; }
.card-top { display: flex; gap: 6px; margin-bottom: 12px; }
.tag { font-size: 9px; padding: 3px 10px; background: #f9f9f9; border: 1px solid #eee; border-radius: 6px; color: #888; font-weight: 700; text-transform: uppercase; }

.card-body { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.m-title { font-size: 14px; font-weight: 800; color: #333; text-transform: uppercase; }
.prize-txt { color: var(--p-green); font-size: 13px; font-weight: bold; margin-top: 15px; }

.right-side { text-align: right; }
.match-thumb { width: 75px; height: 75px; border-radius: 12px; object-fit: cover; background: #f0f0f0; }
.m-date { font-size: 10px; font-weight: bold; color: #ff4d4d; margin-top: 6px; text-transform: uppercase; }

.progress-container { margin-top: 15px; border-top: 1px solid #f9f9f9; padding-top: 12px; }
.bar-bg { width: 50%; height: 6px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
.bar-fill { height: 100%; background: var(--p-green); border-radius: 10px; transition: 0.8s ease; }
.spots-txt { font-size: 11px; font-weight: 800; margin-top: 7px; }

.join-btn-dashboard { 
    position: absolute; bottom: 0; right: 0; 
    background: var(--p-green); color: #fff; padding: 12px 35px; 
    border-radius: 25px 0 0 0; font-weight: 800; font-size: 12px; 
    clip-path: polygon(15% 0, 100% 0, 100% 100%, 0% 100%); 
    border: none; cursor: pointer; box-shadow: -2px -2px 10px rgba(0,0,0,0.05);
}

.bottom-nav{ display:flex; justify-content:space-around; align-items:center; position:fixed; bottom:0; width:100%; background:white; padding:10px 0; border-top: 1px solid #eee; z-index: 100; }
.bottom-nav div{ display:flex; flex-direction:column; align-items:center; color:#bbb; font-size:10px; font-weight: bold; gap:5px; cursor: pointer; }
.bottom-nav .active{ color:var(--p-green); }
.bottom-nav i { font-size: 18px; }
</style>
</head>
<body>

<div id="loader"><div class="spinner"></div></div>

<div class="header">
 <div class="header-left">
   <img id="profilePic" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" onclick="location.href='profile.html'">
   <span id="usernameDisplay">Loading Profile...</span>
 </div>
 <div class="wallet-box" id="walletAmount">â‚¹0</div>
</div>

<div class="categories" id="categoryBar">
 <div class="category active" onclick="filterMatches(this, 'BR PER KILL')">BR PER KILL</div>
 <div class="category" onclick="filterMatches(this, 'BR SURVIVAL')">BR SURVIVAL</div>
 <div class="category" onclick="filterMatches(this, 'CS HEADSHOT')">CS HEADSHOT</div>
 <div class="category" onclick="filterMatches(this, 'CLASH SQUAD')">CLASH SQUAD</div>
</div>

<div id="matchContainer" class="matches-container"></div>

<div class="bottom-nav">
 <div class="active"><i class="fa-solid fa-house"></i>Home</div>
 <div onclick="location.href='my-matches.html'"><i class="fa-solid fa-gamepad"></i>My Matches</div>
 <div onclick="location.href='task.html'"><i class="fa-solid fa-tasks"></i>Tasks</div>
 <div onclick="location.href='wallet.html'"><i class="fa-solid fa-wallet"></i>Wallet</div>
 <div onclick="location.href='profile.html'"><i class="fa-solid fa-user"></i>Profile</div>
</div>

<script>
window.addEventListener("load", () => {
    setTimeout(() => { document.getElementById("loader").style.display = "none"; }, 600);
});

const firebaseConfig = {
 apiKey: "AIzaSyBrHcONT6y0he3fzrtRGqdQMZfIMpGxcNo",
 authDomain: "kl-esports.firebaseapp.com",
 databaseURL: "https://kl-esports-default-rtdb.firebaseio.com",
 projectId: "kl-esports",
 storageBucket: "kl-esports.appspot.com",
 messagingSenderId: "440301376580",
 appId: "1:440301376580:web:fb0b8ae0df3fe096bd1811"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentCategory = "BR PER KILL";

function formatMatchTime(dateStr) {
    if(!dateStr) return "";
    const date = new Date(dateStr);
    const options = { day: 'numeric', month: 'short' };
    const datePart = date.toLocaleDateString('en-GB', options);
    let hours = date.getHours();
    let minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;
    minutes = minutes < 10 ? '0' + minutes : minutes;
    return `${datePart} ${hours}:${minutes} ${ampm}`;
}

function filterMatches(element, category) {
    document.querySelectorAll('.category').forEach(c => c.classList.remove('active'));
    element.classList.add('active');
    currentCategory = category;
    loadMatches();
}

function loadMatches() {
    const container = document.getElementById('matchContainer');
    const user = auth.currentUser;
    const now = new Date();

    db.ref('matches').on('value', snapshot => {
        container.innerHTML = "";
        let matchList = [];

        snapshot.forEach(child => {
            const data = child.val();
            data.key = child.key;
            matchList.push(data);
        });

        matchList.sort((a, b) => new Date(a.time) - new Date(b.time));

        matchList.forEach(data => {
            if(data.category === currentCategory) {
                const matchTime = new Date(data.time);
                if(matchTime <= now) return;

                let isJoined = false;
                if(data.participants && user) {
                    if(data.participants[user.uid]) isJoined = true;
                }
                if(isJoined) return;

                const joined = parseInt(data.joined) || 0;
                const max = parseInt(data.max) || 48;
                const slotsLeft = max - joined;
                const progress = (joined / max) * 100;
                const slotColor = slotsLeft <= 5 ? '#ff4d4d' : '#0fa958';

                const card = document.createElement('div');
                card.className = 'match-card';
                card.onclick = (e) => {
                    if(!e.target.classList.contains('join-btn-dashboard')) {
                        location.href = `card.html?id=${data.key}`;
                    }
                };

                card.innerHTML = `
                    <div class="card-top">
                        <span class="tag">${data.teamType}</span>
                        <span class="tag">${data.map || 'BERMUDA'}</span>
                        <span class="tag">${max} SLOTS</span>
                    </div>
                    <div class="card-body">
                        <div>
                            <div class="m-title">FREE FIRE - ${data.category}</div>
                            <div class="prize-txt">Prize Pool - â‚¹${data.prize}</div>
                        </div>
                        <div class="right-side">
                            <img src="${data.thumbnail}" class="match-thumb">
                            <div class="m-date">${formatMatchTime(data.time)}</div>
                        </div>
                    </div>
                    <div class="progress-container">
                        <div class="bar-bg"><div class="bar-fill" style="width:${progress}%"></div></div>
                        <div class="spots-txt" style="color: ${slotColor}">
                            ${slotsLeft <= 0 ? 'Fully Booked' : slotsLeft + ' Slots Remaining'}
                        </div>
                    </div>
                    <button class="join-btn-dashboard" 
                        onclick="directJoin('${data.key}', ${data.entry}, ${joined}, ${max})">
                        â‚¹${data.entry} JOIN
                    </button>
                `;
                container.appendChild(card);
            }
        });

        if(container.innerHTML === "") {
            container.innerHTML = "<div style='text-align:center; padding:50px 30px; color:#ccc; font-size:13px;'>No upcoming matches in this category.</div>";
        }
    });
}

// ðŸ”¥ DIRECT JOIN WITH OBJECT WALLET SUPPORT
function directJoin(mKey, entry, joinedCount, maxCount) {
    const user = auth.currentUser;
    if(!user) return;
    
    db.ref("users/" + user.uid).once('value', snapshot => {
        const uData = snapshot.val();
        if(!uData.gameName || !uData.gameID) {
            alert("Update Game Name & ID in Settings first!");
            location.href = "settings.html"; return;
        }

        // Wallet check (Object vs Number)
        let dep = 0, win = 0;
        if(uData.wallet && typeof uData.wallet === 'object') {
            dep = parseInt(uData.wallet.deposit || 0);
            win = parseInt(uData.wallet.winnings || 0);
        } else {
            dep = parseInt(uData.wallet || 0);
        }

        if((dep + win) < entry) { alert("Insufficient Balance!"); return; }
        if(joinedCount >= maxCount) { alert("Match Full!"); return; }

        if(confirm(`Join for â‚¹${entry}?`)) {
            // Priority Deduction Logic
            let newDep = dep;
            let newWin = win;
            if (newDep >= entry) {
                newDep -= entry;
            } else {
                let rem = entry - newDep;
                newDep = 0;
                newWin -= rem;
            }

            const updates = {};
            updates['/users/' + user.uid + '/wallet'] = { deposit: newDep, winnings: newWin };
            updates['/matches/' + mKey + '/joined'] = (joinedCount + 1);
            
            db.ref('matches/' + mKey + '/participants/' + user.uid).set({
                uid: user.uid, gameName: uData.gameName, gameID: uData.gameID, joinedAt: Date.now()
            }).then(() => {
                db.ref().update(updates).then(() => alert("Tournament Joined!"));
            });
        }
    });
}

auth.onAuthStateChanged(user => {
 if(user){
   db.ref("users/" + user.uid).on('value', snapshot => {
     const userData = snapshot.val();
     if(userData) {
       document.getElementById("usernameDisplay").innerText = userData.username || "Gamer";
       
       // ðŸ”¥ WALLET DISPLAY FIX
       let total = 0;
       if(userData.wallet && typeof userData.wallet === 'object') {
           total = parseInt(userData.wallet.deposit || 0) + parseInt(userData.wallet.winnings || 0);
       } else {
           total = parseInt(userData.wallet || 0);
       }
       document.getElementById("walletAmount").innerText = "â‚¹" + total;
       
       document.getElementById("profilePic").src = userData.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
     }
     loadMatches();
   });
 } else { window.location.href = "login.html"; }
});
</script>
</body>
</html>
