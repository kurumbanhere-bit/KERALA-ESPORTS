<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Wallet - KERALA ESPORTS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --p-green: #0fa958; --bg: #f8fbf9; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; padding-bottom: 30px; }
        .top-bar { display: flex; align-items: center; padding: 15px; background: white; font-weight: bold; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .top-bar i { margin-right: 15px; cursor: pointer; color: var(--p-green); font-size: 20px; }
        .wallet-section { background: #fff; margin: 20px; border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; }
        .total-box .label { font-size: 11px; font-weight: 800; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .total-box .amount { font-size: 42px; font-weight: 900; color: #222; margin: 10px 0 25px; }
        .sub-wallets { display: flex; justify-content: space-between; gap: 15px; border-top: 1px dashed #eee; padding-top: 20px; }
        .sw-box { flex: 1; text-align: center; background: #fcfdfc; padding: 15px 5px; border-radius: 20px; border: 1px solid #f0f4f1; }
        .sw-box .sw-label { font-size: 10px; font-weight: 800; color: #777; margin-bottom: 5px; display: block; }
        .sw-box .sw-amt { font-size: 20px; font-weight: 800; }
        .dep-tag { color: var(--p-green); }
        .win-tag { color: #ff4d4d; }
        .action-row { display: flex; justify-content: space-around; padding: 0 20px; gap: 15px; }
        .action-btn { flex: 1; padding: 18px; border-radius: 20px; border: 1px solid #eee; font-weight: 800; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; background: white; text-decoration: none; color: inherit; font-size: 12px; transition: 0.2s; }
        .action-btn i { font-size: 24px; }
    </style>
</head>
<body>

<div class="top-bar">
    <i class="fa-solid fa-arrow-left" onclick="history.back()"></i>
    <span>MY WALLET</span>
</div>

<div class="wallet-section">
    <div class="total-box">
        <span class="label">Total Balance</span>
        <div class="amount" id="totalDisplay">₹0</div>
    </div>
    <div class="sub-wallets">
        <div class="sw-box">
            <span class="sw-label">Deposit Money</span>
            <div class="sw-amt dep-tag" id="depDisplay">₹0</div>
        </div>
        <div class="sw-box">
            <span class="sw-label">Winnings</span>
            <div class="sw-amt win-tag" id="winDisplay">₹0</div>
        </div>
    </div>
</div>

<div class="action-row">
    <a href="add-money.html" class="action-btn">
        <i class="fa-solid fa-circle-plus" style="color:var(--p-green)"></i>
        <span>Add Money</span>
    </a>
    <button class="action-btn" onclick="goToWithdraw()">
        <i class="fa-solid fa-arrow-up-right-from-square" style="color:#ff4d4d"></i>
        <span>Withdraw</span>
    </button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBrHcONT6y0he3fzrtRGqdQMZfIMpGxcNo",
        authDomain: "kl-esports.firebaseapp.com",
        databaseURL: "https://kl-esports-default-rtdb.firebaseio.com",
        projectId: "kl-esports",
        storageBucket: "kl-esports.appspot.com",
        messagingSenderId: "440301376580",
        appId: "1:440301376580:web:fb0b8ae0df3fe096bd1811"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentWinnings = 0;

    firebase.auth().onAuthStateChanged(user => {
        if(user) {
            db.ref("users/" + user.uid + "/wallet").on('value', snapshot => {
                const data = snapshot.val();
                let dep = 0, win = 0;

                if (data !== null) {
                    if (typeof data === 'object') {
                        dep = parseInt(data.deposit || 0);
                        win = parseInt(data.winnings || 0);
                    } else {
                        dep = parseInt(data || 0);
                        win = 0;
                    }
                }
                currentWinnings = win;
                document.getElementById("depDisplay").innerText = "₹" + dep;
                document.getElementById("winDisplay").innerText = "₹" + win;
                document.getElementById("totalDisplay").innerText = "₹" + (dep + win);
            });
        } else { window.location.href = "index.html"; }
    });

    // Withdrawal Restriction Check
    function goToWithdraw() {
        if(currentWinnings <= 0) {
            alert("Ninte kayyil winnings illa Boss! Deposit money withdraw cheyyaan pattilla.");
        } else {
            window.location.href = "withdraw.html";
        }
    }

    // --- SMART MATCH JOIN LOGIC ---
    // Match join cheyyumpol ee function call cheyyuka
    function joinMatch(matchFee) {
        const user = firebase.auth().currentUser;
        const walletRef = db.ref('users/' + user.uid + '/wallet');

        walletRef.transaction(wallet => {
            if (!wallet) return;

            let d = parseInt(wallet.deposit || 0);
            let w = parseInt(wallet.winnings || 0);

            if ((d + w) < matchFee) {
                alert("Insufficient Funds!");
                return;
            }

            let remaining = matchFee;

            // Step 1: Priority to Deposit Money
            if (d >= remaining) {
                wallet.deposit = d - remaining;
                remaining = 0;
            } else {
                remaining -= d;
                wallet.deposit = 0;
            }

            // Step 2: Remainder from Winnings
            if (remaining > 0) {
                wallet.winnings = w - remaining;
            }

            return wallet;
        }, (error, committed) => {
            if (committed) alert("Joined! Aadyam Deposit eduthu, baaki winnings-um.");
        });
    }
</script>
</body>
</html>
