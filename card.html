<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Match Details - KL ESPORTS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
    :root { --p-green: #0fa958; --bg-light: #f5fff9; --white: #ffffff; --gold: #ffd700; --text-dark: #1a1a1a; --red: #ff4d4d; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-light); color: #333; padding-bottom: 90px; }
    
    .header { background: var(--white); padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
    .header i { font-size: 20px; color: var(--p-green); margin-right: 15px; cursor: pointer; }
    .header span { font-size: 18px; font-weight: bold; }

    .match-preview { background: var(--white); margin: 15px; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
    .m-title { font-size: 18px; font-weight: 800; text-transform: uppercase; }
    .m-prize-main { font-size: 22px; font-weight: 900; color: var(--p-green); margin-top: 4px; }
    .m-date { font-size: 11px; font-weight: 800; color: var(--red); margin-top: 8px; text-transform: uppercase; display: inline-block; background: #fff5f5; padding: 4px 8px; border-radius: 5px; }

    .room-card-white { background: var(--white); margin: 0 15px 15px 15px; padding: 18px; border-radius: 15px; border: 2px solid var(--p-green); box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: none; }
    .room-title-label { font-size: 11px; color: #555; font-weight: 800; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .room-grid { display: flex; justify-content: space-between; gap: 10px; }
    .room-item-box { flex: 1; background: #f9f9f9; padding: 12px; border-radius: 10px; border: 1px solid #f0f0f0; text-align: center; }
    .room-label-small { font-size: 9px; color: #999; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
    .room-value-text { font-size: 14px; font-weight: 800; color: #222; font-family: monospace; }
    .pending-status { color: var(--red) !important; font-family: 'Segoe UI' !important; font-size: 12px; }

    /* WINNER UI STYLING */
    .winner-header-label { font-size: 13px; font-weight: 800; text-align: center; color: #555; margin: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
    .winner-card { background: white; margin: 0 15px 10px 15px; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .win-left { display: flex; align-items: center; gap: 12px; }
    .win-rank { width: 30px; height: 30px; background: var(--gold); color: #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 900; }
    .win-name { font-weight: 800; font-size: 14px; color: #222; }
    .win-stats { font-size: 10px; color: #777; font-weight: bold; margin-top: 2px; }
    .win-prize { font-weight: 900; color: var(--p-green); font-size: 15px; }

    .tabs { display: flex; background: #f0f0f0; margin: 15px; border-radius: 12px; padding: 4px; }
    .tab { flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 700; color: #777; cursor: pointer; border-radius: 10px; }
    .tab.active { background: white; color: var(--p-green); }

    .rule-item { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-start; }
    .rule-num { min-width: 22px; height: 22px; background: var(--p-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
    .rule-text { font-size: 13px; color: #444; line-height: 1.4; }

    .footer { position: fixed; bottom: 0; width: 100%; background: var(--white); padding: 15px 20px; box-sizing: border-box; border-top: 1px solid #eee; }
    .btn-join { background: var(--p-green); color: var(--white); width: 100%; border: none; padding: 16px; border-radius: 12px; font-weight: 800; cursor: pointer; }
</style>
</head>
<body>

<div class="header">
    <i class="fa-solid fa-arrow-left" onclick="history.back()"></i>
    <span id="headerTitle">Match Details</span>
</div>

<div class="match-preview" id="commonMatchInfo">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <div class="m-title" id="mTitle">Loading...</div>
            <div class="m-prize-main" id="mPrizeHeader">‚Çπ0</div>
            <div id="mDate" class="m-date"></div>
        </div>
        <img src="" id="mThumb" style="width:75px; height:75px; border-radius:12px; object-fit: cover;">
    </div>
</div>

<div class="room-card-white" id="roomInfoBox">
    <div class="room-title-label"><i class="fa-solid fa-door-open" style="color:var(--p-green)"></i> Room Details (Ongoing)</div>
    <div class="room-grid">
        <div class="room-item-box">
            <div class="room-label-small">Room ID</div>
            <div class="room-value-text" id="displayRoomId">Updating...</div>
        </div>
        <div class="room-item-box">
            <div class="room-label-small">Password</div>
            <div class="room-value-text" id="displayRoomPass">Updating...</div>
        </div>
    </div>
</div>

<div id="completedUI" style="display:none;">
    <div class="winner-header-label">üèÜ Match Winners üèÜ</div>
    <div id="winnersList"></div>
</div>

<div id="activeTabsUI">
    <div class="tabs">
        <div class="tab active" onclick="showTab('prize')">Prize Pool</div>
        <div class="tab" onclick="showTab('players')">Players</div>
        <div class="tab" onclick="showTab('rules')">Rules</div>
    </div>
    
    <div id="prizeSection"><div id="prizeList" style="background:white; margin:0 15px; border-radius:12px; border:1px solid #eee;"></div></div>
    
    <div id="playerSection" style="display:none;"><div id="playerList"></div></div>
    
    <div id="rulesSection" style="display:none; padding: 20px; background: white; margin: 0 15px; border-radius: 12px; border: 1px solid #eee;">
        <div class="rule-item"><div class="rule-num">1</div><div class="rule-text"><b>POV Required:</b> Start screen recording before entering room. Mandatory for every player.</div></div>
        <div class="rule-item"><div class="rule-num">2</div><div class="rule-text"><b>Slot Change:</b> Will lead to <b>Kick & No Refund</b>.</div></div>
        <div class="rule-item"><div class="rule-num">3</div><div class="rule-text">Only mobile players allowed. Minimum <b>Level 40</b> required.</div></div>
        <div class="rule-item"><div class="rule-num">4</div><div class="rule-text"><b>Unregistered Invite:</b> Kick + No Refund. Kill points will not count.</div></div>
        <div class="rule-item"><div class="rule-num">5</div><div class="rule-text">ID & Password share <b>10 min</b> before start. Late join = No Refund.</div></div>
        <div class="rule-item"><div class="rule-num">6</div><div class="rule-text"><b>Fair Play:</b> Panels, Hacks, or Glitches = <b>Account Ban + Wallet Freeze</b>.</div></div>
        <div class="rule-item"><div class="rule-num">7</div><div class="rule-text">Results declare within 1 hour. Suspended matches get full refund.</div></div>
        <div class="rule-item"><div class="rule-num">8</div><div class="rule-text">Winning prize only if POV is provided within 24 hours.</div></div>
    </div>

    <div class="footer" id="joinFooter"><button class="btn-join" onclick="handleJoin()">JOIN NOW</button></div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBrHcONT6y0he3fzrtRGqdQMZfIMpGxcNo",
    authDomain: "kl-esports.firebaseapp.com",
    databaseURL: "https://kl-esports-default-rtdb.firebaseio.com",
    projectId: "kl-esports",
    storageBucket: "kl-esports.appspot.com",
    messagingSenderId: "440301376580",
    appId: "1:440301376580:web:fb0b8ae0df3fe096bd1811"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const matchId = new URLSearchParams(window.location.search).get('id');

let entryFee = 0;
let userWallet = 0;

auth.onAuthStateChanged(user => {
    if(user) {
        db.ref("users").on('value', snap => {
            const allUsers = snap.val();
            for(let key in allUsers) {
                if(key.includes(user.uid)) { userWallet = allUsers[key].wallet || 0; break; }
            }
        });
    }
});

function formatMatchTime(dateStr) {
    if(!dateStr) return "";
    const date = new Date(dateStr);
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let hours = date.getHours();
    let minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;
    minutes = minutes < 10 ? '0' + minutes : minutes;
    return `${date.getDate()} ${months[date.getMonth()]} | ${hours}:${minutes} ${ampm}`;
}

if(matchId) {
    db.ref('matches/' + matchId).on('value', snap => {
        const data = snap.val();
        if(!data) return;

        entryFee = data.fee || 0;
        document.getElementById('mTitle').innerText = data.category;
        document.getElementById('mPrizeHeader').innerText = "‚Çπ" + data.prize;
        document.getElementById('mThumb').src = data.thumbnail;
        document.getElementById('mDate').innerText = formatMatchTime(data.time);

        // --- COMPLETED STATUS LOGIC ---
        if(data.status === "Completed" || data.status === "completed" || data.winners) {
            document.getElementById('activeTabsUI').style.display = "none";
            document.getElementById('roomInfoBox').style.display = "none";
            document.getElementById('completedUI').style.display = "block";
            
            let winHTML = "";
            if(data.winners) {
                Object.values(data.winners).forEach(w => {
                    winHTML += `
                    <div class="winner-card">
                        <div class="win-left">
                            <div class="win-rank">${w.position || '#'}</div>
                            <div>
                                <div class="win-name">${w.playerName}</div>
                                <div class="win-stats">KILLS: ${w.kills || 0}</div>
                            </div>
                        </div>
                        <div class="win-prize">‚Çπ${w.prizeWon || 0}</div>
                    </div>`;
                });
            } else {
                winHTML = "<div style='text-align:center; padding:20px; color:#999;'>Results updating...</div>";
            }
            document.getElementById('winnersList').innerHTML = winHTML;
        } else {
            document.getElementById('activeTabsUI').style.display = "block";
            document.getElementById('completedUI').style.display = "none";

            // Room Info Timer
            const matchStartTime = new Date(data.time).getTime();
            const currentTime = new Date().getTime();
            if (currentTime >= (matchStartTime - (15 * 60 * 1000))) {
                document.getElementById('roomInfoBox').style.display = "block";
                document.getElementById('displayRoomId').innerText = data.roomId || "Soon";
                document.getElementById('displayRoomPass').innerText = data.roomPass || "Soon";
            }
        }

        // Prize Dist
        let pl = "";
        if(data.prizeDist) data.prizeDist.split(',').forEach(i => {
            let p = i.split(':');
            pl += `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #f8f8f8; font-weight:bold; font-size:14px;">
                <span>${p[0]}</span><span style="color:var(--p-green)">${p[1]}</span>
            </div>`;
        });
        document.getElementById('prizeList').innerHTML = pl;
    });
}

function showTab(type) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('prizeSection').style.display = type === 'prize' ? 'block' : 'none';
    document.getElementById('playerSection').style.display = type === 'players' ? 'block' : 'none';
    document.getElementById('rulesSection').style.display = type === 'rules' ? 'block' : 'none';
    if(type === 'players') loadPlayers();
}

function handleJoin() {
    if(userWallet < entryFee) {
        alert("Insufficient Balance!");
        window.location.href = "add-money.html";
    } else {
        alert("Joining...");
    }
}

function loadPlayers() {
    const listDiv = document.getElementById('playerList');
    db.ref('matches/' + matchId + '/participants').on('value', snapshot => {
        listDiv.innerHTML = "";
        snapshot.forEach(child => {
            const part = child.val();
            db.ref('users/' + part.uid).once('value', uSnap => {
                const u = uSnap.val();
                const img = (u && u.profilePic) ? u.profilePic : 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                listDiv.innerHTML += `
                <div style="display:flex; align-items:center; gap:12px; padding:12px; background:white; margin:0 15px 10px 15px; border-radius:12px; border:1px solid #eee;">
                    <img src="${img}" style="width:38px; height:38px; border-radius:50%; object-fit:cover; border: 1px solid #eee;">
                    <div><div style="font-weight:bold; font-size:14px;">${u ? u.username : 'User'}</div><div style="font-size:10px; color:#888;">IGN: ${part.gameName}</div></div>
                </div>`;
            });
        });
    });
}
</script>
</body>
</html>
