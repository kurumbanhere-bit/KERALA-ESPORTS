<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Match Details - KL ESPORTS</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
    :root { --p-green: #0fa958; --bg-light: #f5fff9; --white: #ffffff; --gold: #ffd700; --silver: #c0c0c0; --bronze: #cd7f32; --text-dark: #1a1a1a; --red: #ff4d4d; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-light); color: #333; padding-bottom: 90px; }
    
    .header { background: var(--white); padding: 15px; display: flex; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
    .header i { font-size: 20px; color: var(--p-green); margin-right: 15px; cursor: pointer; }
    .header span { font-size: 18px; font-weight: bold; }

    .match-preview { background: var(--white); margin: 15px; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
    .m-title { font-size: 18px; font-weight: 800; text-transform: uppercase; }
    .m-prize-main { font-size: 22px; font-weight: 900; color: var(--p-green); margin-top: 4px; }
    .m-date { font-size: 11px; font-weight: 800; color: var(--red); margin-top: 8px; text-transform: uppercase; display: inline-block; background: #fff5f5; padding: 4px 8px; border-radius: 5px; }

    .room-card-white { background: var(--white); margin: 0 15px 15px 15px; padding: 18px; border-radius: 15px; border: 2px solid var(--p-green); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .room-title-label { font-size: 11px; color: #555; font-weight: 800; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .room-grid { display: flex; justify-content: space-between; gap: 10px; }
    .room-item-box { flex: 1; background: #f9f9f9; padding: 12px; border-radius: 10px; border: 1px solid #f0f0f0; text-align: center; }
    .room-label-small { font-size: 9px; color: #999; text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
    .room-value-text { font-size: 14px; font-weight: 800; color: #222; font-family: monospace; }

    .winner-header-label { font-size: 13px; font-weight: 800; text-align: center; color: #555; margin: 20px 0 10px 0; text-transform: uppercase; letter-spacing: 1px; }
    .winner-card { background: white; margin: 0 15px 10px 15px; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
    .win-rank { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 900; color: #000; border: 2px solid rgba(0,0,0,0.05); }
    .rank-1 { background: var(--gold); }
    .rank-2 { background: var(--silver); }
    .rank-3 { background: var(--bronze); color: #fff; }
    .rank-other { background: #eee; }

    .tabs { display: flex; background: #f0f0f0; margin: 15px; border-radius: 12px; padding: 4px; }
    .tab { flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 700; color: #777; cursor: pointer; border-radius: 10px; }
    .tab.active { background: white; color: var(--p-green); }

    .player-row { display: flex; align-items: center; gap: 15px; background: white; margin: 0 15px 10px 15px; padding: 12px; border-radius: 12px; border: 1px solid #eee; }
    .player-img { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--p-green); background: #f0f0f0; }
    .p-user-name { font-weight: 800; font-size: 14px; color: #222; }
    .p-game-name { font-size: 11px; color: var(--p-green); font-weight: 700; text-transform: uppercase; }

    .rule-item { display: flex; gap: 12px; margin-bottom: 15px; align-items: flex-start; }
    .rule-num { min-width: 24px; height: 24px; background: var(--p-green); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
    .rule-text { font-size: 12.5px; color: #444; line-height: 1.5; }

    .footer { position: fixed; bottom: 0; width: 100%; background: var(--white); padding: 15px 20px; box-sizing: border-box; border-top: 1px solid #eee; }
    .btn-join { background: var(--p-green); color: var(--white); width: 100%; border: none; padding: 16px; border-radius: 12px; font-weight: 800; cursor: pointer; }
    .btn-join:disabled { background: #888; cursor: not-allowed; }
</style>
</head>
<body>

<div class="header">
    <i class="fa-solid fa-arrow-left" onclick="history.back()"></i>
    <span id="headerTitle">JOINED 0/48</span>
</div>

<div class="match-preview">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <div class="m-title" id="mTitle">Loading...</div>
            <div class="m-prize-main" id="mPrizeHeader">‚Çπ0</div>
            <div id="mDate" class="m-date"></div>
        </div>
        <img src="" id="mThumb" style="width:75px; height:75px; border-radius:12px; object-fit: cover;">
    </div>
</div>

<div class="room-card-white" id="roomInfoBox">
    <div class="room-title-label"><i class="fa-solid fa-door-open" style="color:var(--p-green)"></i> Room Details</div>
    <div class="room-grid">
        <div class="room-item-box">
            <div class="room-label-small">Room ID</div>
            <div class="room-value-text" id="displayRoomId">Coming Soon</div>
        </div>
        <div class="room-item-box">
            <div class="room-label-small">Password</div>
            <div class="room-value-text" id="displayRoomPass">Coming Soon</div>
        </div>
    </div>
</div>

<div id="completedUI" style="display:none;">
    <div class="winner-header-label">üèÜ Tournament Results üèÜ</div>
    <div id="winnersList"></div>
</div>

<div id="activeTabsUI">
    <div class="tabs">
        <div class="tab active" onclick="showTab('prize')">Prize Pool</div>
        <div class="tab" onclick="showTab('players')">Players</div>
        <div class="tab" onclick="showTab('rules')">Rules</div>
    </div>
    
    <div id="prizeSection"><div id="prizeList" style="background:white; margin:0 15px; border-radius:12px; border:1px solid #eee;"></div></div>
    
    <div id="playerSection" style="display:none;"><div id="playerList"></div></div>
    
    <div id="rulesSection" style="display:none; padding: 20px; background: white; margin: 0 15px; border-radius: 12px; border: 1px solid #eee;">
        <div class="rule-item"><div class="rule-num">1</div><div class="rule-text"><b>POV Required:</b> Start screen recording before entering room.</div></div>
        <div class="rule-item"><div class="rule-num">2</div><div class="rule-text"><b>Slot Change:</b> Stick to your slot. No refund for mismatch.</div></div>
        <div class="rule-item"><div class="rule-num">3</div><div class="rule-text">Only mobile players allowed. Emulators/Panels are banned.</div></div>
        <div class="rule-item"><div class="rule-num">4</div><div class="rule-text"><b>Unregistered Invite:</b> Inviting others leads to kick without refund.</div></div>
        <div class="rule-item"><div class="rule-num">5</div><div class="rule-text">ID & Password shared 10-15 mins before start.</div></div>
        <div class="rule-item"><div class="rule-num">6</div><div class="rule-text"><b>Fair Play:</b> Hacks lead to Ban + Wallet Freeze.</div></div>
        <div class="rule-item"><div class="rule-num">7</div><div class="rule-text">Results declared within 1 hour after match.</div></div>
        <div class="rule-item"><div class="rule-num">8</div><div class="rule-text"><b>POV Claim:</b> Winners must provide POV within 24h if requested.</div></div>
    </div>

    <div class="footer" id="joinFooter">
        <button class="btn-join" id="joinBtn" onclick="handleJoin()">JOIN NOW</button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBrHcONT6y0he3fzrtRGqdQMZfIMpGxcNo",
    authDomain: "kl-esports.firebaseapp.com",
    databaseURL: "https://kl-esports-default-rtdb.firebaseio.com",
    projectId: "kl-esports",
    storageBucket: "kl-esports.appspot.com",
    messagingSenderId: "440301376580",
    appId: "1:440301376580:web:fb0b8ae0df3fe096bd1811"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const matchId = new URLSearchParams(window.location.search).get('id');

let currentUid = "";
let userGameName = "";
let currentBalance = 0;
let entryFee = 0;

// üî• WALLET LOGIC FIX FOR OBJECTS
auth.onAuthStateChanged(user => {
    if(user) {
        currentUid = user.uid;
        db.ref("users/" + user.uid).on('value', snap => {
            const data = snap.val();
            if(data) {
                userGameName = data.gameName || "Player";
                
                let walletData = data.wallet;
                if (walletData !== null && typeof walletData === 'object') {
                    currentBalance = parseInt(walletData.deposit || 0) + parseInt(walletData.winnings || 0);
                } else {
                    currentBalance = parseInt(walletData || 0);
                }
            }
        });
    } else { window.location.href = "login.html"; }
});

function formatMatchTime(dateStr) {
    if(!dateStr) return "";
    const date = new Date(dateStr);
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let hours = date.getHours(), minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12; minutes = minutes < 10 ? '0' + minutes : minutes;
    return `${date.getDate()} ${months[date.getMonth()]} | ${hours}:${minutes} ${ampm}`;
}

if(matchId) {
    db.ref('matches/' + matchId).on('value', snap => {
        const data = snap.val(); if(!data) return;
        entryFee = parseInt(data.entry || 0);
        const participants = data.participants || {};
        const joinedCount = Object.keys(participants).length;
        const maxSlots = parseInt(data.max || 48);

        document.getElementById('headerTitle').innerText = `JOINED ${joinedCount}/${maxSlots}`;
        document.getElementById('mTitle').innerText = data.category;
        document.getElementById('mPrizeHeader').innerText = "‚Çπ" + data.prize;
        document.getElementById('mThumb').src = data.thumbnail;
        document.getElementById('mDate').innerText = formatMatchTime(data.time);
        document.getElementById('displayRoomId').innerText = data.roomId || "Coming Soon";
        document.getElementById('displayRoomPass').innerText = data.roomPass || "Coming Soon";

        const jBtn = document.getElementById('joinBtn');
        if(participants[currentUid]) {
            jBtn.innerText = "ALREADY JOINED"; jBtn.disabled = true; jBtn.style.background = "#888";
        } else if(joinedCount >= maxSlots) {
            jBtn.innerText = "MATCH FULL"; jBtn.disabled = true;
        } else {
            jBtn.innerText = "JOIN NOW"; jBtn.disabled = false;
        }

        if(data.status === "Completed") {
            document.getElementById('activeTabsUI').style.display = "none";
            document.getElementById('roomInfoBox').style.display = "none";
            document.getElementById('completedUI').style.display = "block";
            let winHTML = "";
            if(data.winners) {
                Object.values(data.winners).sort((a,b)=>a.rank-b.rank).forEach(w => {
                    let rClass = w.rank==1 ? 'rank-1' : (w.rank==2 ? 'rank-2' : (w.rank==3 ? 'rank-3' : 'rank-other'));
                    winHTML += `<div class="winner-card"><div style="display:flex; align-items:center; gap:12px;"><div class="win-rank ${rClass}">${w.rank}</div><div><div style="font-weight:800;">${w.playerName}</div><div style="font-size:10px; color:#888;">KILLS: ${w.kills}</div></div></div><div style="font-weight:900; color:var(--p-green); font-size:16px;">‚Çπ${w.prize}</div></div>`;
                });
            }
            document.getElementById('winnersList').innerHTML = winHTML;
        }

        let pl = "";
        if(data.prizeDist) data.prizeDist.split(',').forEach(i => {
            let p = i.split(':');
            pl += `<div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #f8f8f8; font-weight:bold; font-size:14px;"><span>${p[0]}</span><span style="color:var(--p-green)">${p[1]}</span></div>`;
        });
        document.getElementById('prizeList').innerHTML = pl;
    });
}

function handleJoin() {
    if(currentBalance < entryFee) {
        alert("Insufficient Balance! Your Balance: ‚Çπ" + currentBalance);
        return;
    }

    if(!confirm("Join for ‚Çπ" + entryFee + "?")) return;

    // üî• PRIORITY DEDUCTION (Deposit -> Winnings)
    const userRef = db.ref('users/' + currentUid + '/wallet');
    
    userRef.transaction(currentVal => {
        let dep = 0, win = 0;
        if (currentVal !== null && typeof currentVal === 'object') {
            dep = parseInt(currentVal.deposit || 0);
            win = parseInt(currentVal.winnings || 0);
        } else {
            dep = parseInt(currentVal || 0);
            win = 0;
        }

        if((dep + win) < entryFee) return;

        if (dep >= entryFee) {
            dep -= entryFee;
        } else {
            let rem = entryFee - dep;
            dep = 0;
            win -= rem;
        }
        return { deposit: dep, winnings: win };
    }, (error, committed) => {
        if(committed) {
            db.ref(`matches/${matchId}/participants/${currentUid}`).set({
                uid: currentUid,
                gameName: userGameName,
                joinedAt: Date.now()
            }).then(() => {
                db.ref(`matches/${matchId}/joined`).transaction(c => (c || 0) + 1);
                alert("Successfully Joined! üî•");
            });
        } else {
            alert("Join failed!");
        }
    });
}

function showTab(type) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('prizeSection').style.display = type === 'prize' ? 'block' : 'none';
    document.getElementById('playerSection').style.display = type === 'players' ? 'block' : 'none';
    document.getElementById('rulesSection').style.display = type === 'rules' ? 'block' : 'none';
    if(type === 'players') loadPlayers();
}

function loadPlayers() {
    const listDiv = document.getElementById('playerList');
    listDiv.innerHTML = "<div style='text-align:center; padding:20px;'>Loading...</div>";
    db.ref('matches/' + matchId + '/participants').on('value', snapshot => {
        listDiv.innerHTML = "";
        if(!snapshot.exists()) { listDiv.innerHTML = "<div style='text-align:center; padding:40px;'>No players yet.</div>"; return; }
        snapshot.forEach(child => {
            const part = child.val();
            db.ref('users/' + part.uid).once('value', uSnap => {
                const u = uSnap.val();
                const img = (u && u.profilePic) ? u.profilePic : 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                listDiv.innerHTML += `<div class="player-row"><img src="${img}" class="player-img"><div class="player-info"><div class="p-user-name">${u ? u.username : 'Player'}</div><div class="p-game-name">IGN: ${part.gameName}</div></div></div>`;
            });
        });
    });
}
</script>
</body>
</html>
