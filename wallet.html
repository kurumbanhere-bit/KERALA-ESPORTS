<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Wallet - KERALA ESPORTS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --p-green: #0fa958; --bg: #f8fbf9; --red: #ff4d4d; --white: #ffffff; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; padding-bottom: 30px; }
        .top-bar { display: flex; align-items: center; padding: 15px; background: var(--white); font-weight: bold; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
        .top-bar i { margin-right: 15px; cursor: pointer; color: var(--p-green); font-size: 20px; }
        
        /* Wallet Section */
        .wallet-section { background: #fff; margin: 20px; border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; }
        .total-box .label { font-size: 11px; font-weight: 800; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .total-box .amount { font-size: 42px; font-weight: 900; color: #222; margin: 10px 0 25px; }
        .sub-wallets { display: flex; justify-content: space-between; gap: 15px; border-top: 1px dashed #eee; padding-top: 20px; }
        .sw-box { flex: 1; text-align: center; background: #fcfdfc; padding: 15px 5px; border-radius: 20px; border: 1px solid #f0f4f1; }
        .sw-label { font-size: 10px; font-weight: 800; color: #777; margin-bottom: 5px; display: block; }
        .sw-amt { font-size: 20px; font-weight: 800; }
        .dep-tag { color: var(--p-green); }
        .win-tag { color: var(--red); }
        
        .action-row { display: flex; justify-content: space-around; padding: 0 20px; gap: 15px; }
        .action-btn { flex: 1; padding: 18px; border-radius: 20px; border: 1px solid #eee; font-weight: 800; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; background: white; text-decoration: none; color: inherit; font-size: 12px; transition: 0.2s; }

        /* ðŸ”¥ Transaction History Style */
        .history-section { margin: 20px; background: #fff; border-radius: 25px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .history-title { font-size: 13px; font-weight: 800; color: #666; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }
        .tx-info { display: flex; flex-direction: column; gap: 4px; }
        .tx-type { font-size: 13px; font-weight: 700; color: #333; text-transform: capitalize; }
        
        /* ðŸ”¥ Date & Time combined style */
        .tx-date { font-size: 10px; color: #999; font-weight: 500; }
        
        .tx-status-box { text-align: right; }
        .tx-amt { font-weight: 800; font-size: 14px; margin-bottom: 4px; }
        
        .status-badge { font-size: 9px; padding: 4px 10px; border-radius: 6px; font-weight: 900; text-transform: uppercase; display: inline-block; }
        .pending { background: #fff9c4; color: #fbc02d; } 
        .success { background: #e8f5e9; color: #4caf50; } 
        .failed { background: #ffebee; color: #f44336; }  
    </style>
</head>
<body>

<div class="top-bar"><i class="fa-solid fa-arrow-left" onclick="history.back()"></i><span>MY WALLET</span></div>

<div class="wallet-section">
    <div class="total-box">
        <span class="label">Total Balance</span>
        <div class="amount" id="totalDisplay">â‚¹0</div>
    </div>
    <div class="sub-wallets">
        <div class="sw-box">
            <span class="sw-label">Deposit Money</span>
            <div class="sw-amt dep-tag" id="depDisplay">â‚¹0</div>
        </div>
        <div class="sw-box">
            <span class="sw-label">Winnings</span>
            <div class="sw-amt win-tag" id="winDisplay">â‚¹0</div>
        </div>
    </div>
</div>

<div class="action-row">
    <a href="add-money.html" class="action-btn">
        <i class="fa-solid fa-circle-plus" style="color:var(--p-green)"></i>
        <span>Add Money</span>
    </a>
    <button class="action-btn" onclick="goToWithdraw()">
        <i class="fa-solid fa-arrow-up-right-from-square" style="color:var(--red)"></i>
        <span>Withdraw</span>
    </button>
</div>

<div class="history-section">
    <div class="history-title">TRANSACTION HISTORY</div>
    <div id="txList">
        <p style="text-align:center; font-size:12px; color:#999;">Loading...</p>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBrHcONT6y0he3fzrtRGqdQMZfIMpGxcNo",
        authDomain: "kl-esports.firebaseapp.com",
        databaseURL: "https://kl-esports-default-rtdb.firebaseio.com",
        projectId: "kl-esports",
        storageBucket: "kl-esports.appspot.com",
        messagingSenderId: "440301376580",
        appId: "1:440301376580:web:fb0b8ae0df3fe096bd1811"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let currentWinnings = 0;

    firebase.auth().onAuthStateChanged(user => {
        if(user) {
            db.ref("users/" + user.uid + "/wallet").on('value', snapshot => {
                const data = snapshot.val();
                let dep = 0, win = 0;
                if (data && typeof data === 'object') {
                    dep = Number(data.deposit) || 0;
                    win = Number(data.winnings) || 0;
                } else {
                    dep = Number(data) || 0;
                    win = 0;
                }
                currentWinnings = win;
                document.getElementById("depDisplay").innerText = "â‚¹" + dep;
                document.getElementById("winDisplay").innerText = "â‚¹" + win;
                document.getElementById("totalDisplay").innerText = "â‚¹" + (dep + win);
            });

            db.ref("transactions").orderByChild("uid").equalTo(user.uid).on('value', snapshot => {
                const txList = document.getElementById("txList");
                txList.innerHTML = ""; 
                
                if (snapshot.exists()) {
                    let rows = [];
                    snapshot.forEach(child => {
                        rows.push(child.val());
                    });
                    rows.reverse().forEach(tx => {
                        // ðŸ”¥ Formatting Date and Time
                        const dt = new Date(tx.timestamp);
                        const dateStr = dt.toLocaleDateString('en-IN', {day:'2-digit', month:'short'});
                        const timeStr = dt.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', hour12:true});
                        
                        const statusClass = tx.status.toLowerCase(); 
                        
                        txList.innerHTML += `
                            <div class="tx-item">
                                <div class="tx-info">
                                    <span class="tx-type">${tx.type}</span>
                                    <span class="tx-date">${dateStr} | ${timeStr}</span>
                                </div>
                                <div class="tx-status-box">
                                    <div class="tx-amt">â‚¹${tx.amount}</div>
                                    <span class="status-badge ${statusClass}">${tx.status}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    txList.innerHTML = "<p style='text-align:center; font-size:12px; color:#999;'>No history found.</p>";
                }
            });
        } else {
            window.location.href = "login.html";
        }
    });

    function goToWithdraw() {
        if(currentWinnings < 50) {
            alert("Minimum withdrawal is â‚¹50. Current Winnings: â‚¹" + currentWinnings);
        } else {
            window.location.href = "withdraw.html";
        }
    }
</script>
</body>
</html>
